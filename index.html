<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Dashboard | MT App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple transition for showing/hiding elements */
        .hidden {
            display: none !important;
        }
        #map {
            height: 100%;
            width: 100%;
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Login Section -->
    <div id="login-container" class="flex items-center justify-center h-full">
        <div class="text-center p-8 bg-white rounded-xl shadow-lg max-w-sm w-full">
            <svg class="mx-auto h-12 w-auto text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" />
            </svg>
            <h2 class="mt-6 text-2xl font-bold tracking-tight text-gray-900">Driver Dashboard</h2>
            <p class="mt-2 text-sm text-gray-600">Sign in to view your live location.</p>
            <div id="loading-spinner" class="mt-8 hidden">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
            </div>
            <button id="login-button" class="mt-8 w-full inline-flex justify-center items-center gap-3 rounded-md bg-white px-4 py-3 text-sm font-semibold text-gray-700 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                <svg class="h-5 w-5" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_17_40)"><path d="M47.532 24.5528C47.532 22.9214 47.3997 21.29 47.1172 19.71H24.252V28.71H37.3097C36.6861 31.89 34.853 34.5373 32.0723 36.3827V42.21H40.2311C44.9253 37.8814 47.532 31.83 47.532 24.5528Z" fill="#4285F4"/><path d="M24.252 48.0001C30.9321 48.0001 36.5662 45.7329 40.2311 42.21L32.0723 36.3827C29.805 37.8814 27.0001 38.76 24.252 38.76C18.6179 38.76 13.8223 35.1429 12.0135 30.0814H3.63281V36.0814C7.32121 43.08 15.1938 48.0001 24.252 48.0001Z" fill="#34A853"/><path d="M12.0135 30.0814C11.2933 28.02 10.9132 25.8172 10.9132 23.5543C10.9132 21.2914 11.2933 19.0886 12.0135 17.0271V11.0271H3.63281C1.31346 15.6857 0 20.4814 0 25.5429C0 30.6043 1.31346 35.3186 3.63281 39.9771L12.0135 30.0814Z" fill="#FBBC05"/><path d="M24.252 9.23999C27.432 9.23999 30.2369 10.3628 32.6124 12.5828L40.4554 4.74C36.542 1.31143 30.9321 0 24.252 0C15.1938 0 7.32121 4.92 3.63281 11.9186L12.0135 17.82C13.8223 12.7586 18.6179 9.23999 24.252 9.23999Z" fill="#EA4335"/></g><defs><clipPath id="clip0_17_40"><rect width="48" height="48" fill="white"/></clipPath></defs></svg>
                Sign in with Google
            </button>
        </div>
    </div>

    <!-- Map Section -->
    <div id="map-container" class="h-full w-full hidden">
        <div id="map"></div>
        <div class="absolute top-4 left-1/2 -translate-x-1/2 bg-white rounded-lg shadow-lg p-4 flex items-center gap-4">
            <img id="user-photo" class="h-10 w-10 rounded-full" src="" alt="User photo">
            <div>
                <p class="font-semibold text-gray-900" id="user-name"></p>
                <p class="text-sm text-gray-500" id="user-email"></p>
            </div>
            <button id="logout-button" class="ml-4 text-sm font-medium text-blue-600 hover:text-blue-800">Sign Out</button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import functions from the Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Your web app's Firebase configuration (PASTE YOURS HERE)
        const firebaseConfig = {
            apiKey: "AIzaSyDYCZe95s4y2NaRSv1wFEV1hesVqQ7mJdE",
            authDomain: "mt-app-e83c0.firebaseapp.com",
            projectId: "mt-app-e83c0",
            storageBucket: "mt-app-e83c0.firebasestorage.app",
            messagingSenderId: "219145572981",
            appId: "1:219145572981:web:5f9fe5f6ef71c3fb439e3c",
            measurementId: "G-VG9YWK8C7X"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // UI Elements
        const loginContainer = document.getElementById('login-container');
        const mapContainer = document.getElementById('map-container');
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const loadingSpinner = document.getElementById('loading-spinner');
        const userNameEl = document.getElementById('user-name');
        const userEmailEl = document.getElementById('user-email');
        const userPhotoEl = document.getElementById('user-photo');

        let map;
        let marker;
        let unsubscribeFromFirestore; // To stop listening to Firestore updates on logout

        // --- AUTHENTICATION ---
        loginButton.onclick = () => {
            signInWithPopup(auth, provider)
                .catch((error) => {
                    console.error("Authentication failed:", error);
                    alert("Sign in failed. Please check the console for details.");
                });
        };

        logoutButton.onclick = () => {
            signOut(auth);
        };

        onAuthStateChanged(auth, (user) => {
            loadingSpinner.classList.remove('hidden');
            loginButton.classList.add('hidden');

            if (user) {
                // User is signed in
                console.log("User signed in:", user.uid);
                loginContainer.classList.add('hidden');
                mapContainer.classList.remove('hidden');
                
                // Update user info in the UI
                userNameEl.textContent = user.displayName;
                userEmailEl.textContent = user.email;
                userPhotoEl.src = user.photoURL;

                // Initialize map and start listening for location updates
                if (!map) {
                    initMap();
                }
                listenToLocation(user.uid);

            } else {
                // User is signed out
                console.log("User signed out.");
                loginContainer.classList.remove('hidden');
                mapContainer.classList.add('hidden');
                loadingSpinner.classList.add('hidden');
                loginButton.classList.remove('hidden');

                // Stop listening to Firestore
                if (unsubscribeFromFirestore) {
                    unsubscribeFromFirestore();
                }
            }
        });

        // --- MAP & FIRESTORE ---
        function initMap() {
            // Initial map centered on Greater Noida, India
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 28.4744, lng: 77.5040 },
                zoom: 12,
                mapId: 'DRIVER_MAP_ID' // A simple map ID for styling
            });

            marker = new google.maps.Marker({
                map: map,
                title: "Driver's Location",
                // You can use a custom icon here if you want
            });
        }

        function listenToLocation(uid) {
            const docRef = doc(db, "locations", uid);

            unsubscribeFromFirestore = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const location = data.location; // This is a GeoPoint
                    if (location) {
                        const newPosition = { lat: location.latitude, lng: location.longitude };
                        console.log("New location received:", newPosition);
                        
                        // Update marker position and center the map
                        marker.setPosition(newPosition);
                        map.panTo(newPosition);
                    }
                } else {
                    console.log("No location data found for this user.");
                    // You could show a message to the user here
                }
            }, (error) => {
                console.error("Error listening to location:", error);
            });
        }

    </script>

    <!-- Google Maps API Script -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB1KZLNxXC8M_PP5sLtTvz57GwUFYgRB84&callback=Function.prototype&libraries=marker" async></script>
</body>
</html>
